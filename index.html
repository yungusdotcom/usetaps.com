<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#07090e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>THRIVE — Executive Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #07090e;
  --surface: #0d1117;
  --card: #111820;
  --border: #1c2533;
  --text: #e6edf3;
  --muted: #5a6a7e;
  --accent: #00e5a0;
  --accent2: #00c9ff;
  --green: #00d68f;
  --red: #ff4757;
  --yellow: #ffd166;
  --font: 'Outfit', sans-serif;
  --mono: 'JetBrains Mono', monospace;
}

* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:var(--font); min-height:100vh; overflow-x:hidden; }
body::before {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:0; opacity:0.3;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
}

.wrap { position:relative; z-index:1; padding:24px 32px; max-width:1600px; margin:0 auto; }

/* ── LOGIN ──────────────────────────────────── */
#loginScreen { position:fixed; inset:0; background:var(--bg); z-index:1000; display:flex; align-items:center; justify-content:center; }
.login-box { text-align:center; padding:48px; border:1px solid var(--border); background:var(--card); max-width:420px; width:100%; border-radius:4px; }
.login-box h1 { font-weight:900; font-size:56px; letter-spacing:8px; color:var(--accent); text-shadow:0 0 40px rgba(0,229,160,.25); }
.login-box p { font-family:var(--mono); font-size:10px; letter-spacing:3px; color:var(--muted); margin:8px 0 32px; }
.login-box input { width:100%; background:var(--surface); border:1px solid var(--border); color:var(--text); font-family:var(--mono); font-size:13px; padding:14px 16px; letter-spacing:2px; margin-bottom:12px; outline:none; transition:border-color .2s; border-radius:2px; }
.login-box input:focus { border-color:var(--accent); }
.login-box button { width:100%; background:var(--accent); color:#000; font-family:var(--font); font-weight:700; font-size:16px; letter-spacing:4px; border:none; padding:14px; cursor:pointer; transition:opacity .2s; border-radius:2px; }
.login-box button:hover { opacity:.85; }
.login-error { font-family:var(--mono); font-size:11px; color:var(--red); margin-top:8px; display:none; }

/* ── HEADER ─────────────────────────────────── */
header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:32px; border-bottom:1px solid var(--border); padding-bottom:20px; }
.logo h1 { font-weight:900; font-size:clamp(36px,4vW,60px); letter-spacing:8px; color:var(--accent); line-height:1; text-shadow:0 0 30px rgba(0,229,160,.2); }
.logo p { font-family:var(--mono); font-size:10px; letter-spacing:4px; color:var(--muted); margin-top:4px; }
.header-right { text-align:right; font-family:var(--mono); }
.header-right .hdate { font-size:11px; color:var(--accent); letter-spacing:2px; }
.header-right .hstatus { margin-top:6px; display:flex; align-items:center; gap:8px; justify-content:flex-end; }
.pill { display:inline-block; font-family:var(--mono); font-size:10px; letter-spacing:2px; padding:3px 10px; border-radius:2px; }
.pill.live { background:rgba(0,229,160,.15); color:var(--accent); }
.pill.error { background:rgba(255,61,90,.15); color:var(--red); }
.refresh-btn { background:none; border:1px solid var(--border); color:var(--muted); font-family:var(--mono); font-size:10px; letter-spacing:2px; padding:4px 12px; cursor:pointer; transition:all .2s; border-radius:2px; }
.refresh-btn:hover { border-color:var(--accent); color:var(--accent); }

/* ── NAV TABS ───────────────────────────────── */
.nav-tabs { display:flex; gap:0; margin-bottom:28px; border-bottom:1px solid var(--border); }
.nav-tabs button { background:none; border:none; color:var(--muted); font-family:var(--mono); font-size:11px; letter-spacing:3px; padding:12px 20px; cursor:pointer; transition:all .2s; border-bottom:2px solid transparent; position:relative; }
.nav-tabs button:hover { color:var(--text); }
.nav-tabs button.active { color:var(--accent); border-bottom-color:var(--accent); }

/* ── KPI CARDS ──────────────────────────────── */
.kpi-row { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:28px; }
.kpi { background:var(--card); border:1px solid var(--border); padding:20px; border-radius:3px; }
.kpi .label { font-family:var(--mono); font-size:9px; letter-spacing:3px; color:var(--muted); margin-bottom:8px; text-transform:uppercase; }
.kpi .value { font-weight:800; font-size:24px; letter-spacing:-0.5px; line-height:1; }
.kpi .sub { font-family:var(--mono); font-size:10px; color:var(--muted); margin-top:6px; letter-spacing:1px; }
.kpi .change { font-family:var(--mono); font-size:11px; font-weight:600; margin-top:4px; }
.kpi .change.up { color:var(--green); }
.kpi .change.down { color:var(--red); }

/* ── SECTION TITLES ─────────────────────────── */
.section-title { font-family:var(--mono); font-size:10px; letter-spacing:4px; color:var(--muted); margin:32px 0 16px; text-transform:uppercase; }
.section-title span { color:var(--accent); }

/* ── STORE GRID (WoW) ───────────────────────── */
.store-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:12px; margin-bottom:28px; }
.store-card { background:var(--card); border:1px solid var(--border); padding:16px; border-radius:3px; cursor:pointer; transition:all .2s; border-left:3px solid var(--border); }
.store-card:hover { border-color:var(--accent); transform:translateY(-2px); }
.store-card .sname { font-weight:700; font-size:14px; letter-spacing:1px; margin-bottom:4px; }
.store-card .sval { font-weight:800; font-size:17px; }
.store-card .schange { font-family:var(--mono); font-size:11px; font-weight:600; margin-top:4px; }

/* ── HEATMAP TABLE ──────────────────────────── */
.heatmap-wrap { overflow-x:auto; margin-bottom:28px; }
.heatmap-table { width:100%; border-collapse:collapse; font-family:var(--mono); font-size:11px; }
.heatmap-table th { background:var(--surface); color:var(--muted); font-size:9px; letter-spacing:2px; text-transform:uppercase; padding:10px 8px; text-align:center; border:1px solid var(--border); position:sticky; top:0; z-index:2; white-space:nowrap; }
.heatmap-table th:first-child { text-align:left; min-width:110px; }
.heatmap-table td { padding:8px; text-align:center; border:1px solid var(--border); transition:all .15s; font-size:11px; white-space:nowrap; }
.heatmap-table td:first-child { text-align:left; font-weight:600; color:var(--muted); background:var(--surface); }
.heatmap-table tr:hover td { opacity:.9; }

/* ── STORE DETAIL ───────────────────────────── */
.store-selector { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:20px; }
.store-selector button { background:var(--card); border:1px solid var(--border); color:var(--muted); font-family:var(--mono); font-size:10px; letter-spacing:2px; padding:8px 16px; cursor:pointer; transition:all .2s; border-radius:2px; }
.store-selector button:hover { border-color:var(--text); color:var(--text); }
.store-selector button.active { background:var(--accent); color:#000; border-color:var(--accent); }

/* ── VELOCITY CARDS ─────────────────────────── */
.velocity-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:16px; }
.vel-card { background:var(--card); border:1px solid var(--border); padding:20px; border-radius:3px; }
.vel-card .vname { font-weight:700; font-size:16px; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
.vel-card .vstatus { font-size:13px; }
.vel-card .vrow { display:flex; justify-content:space-between; font-family:var(--mono); font-size:11px; padding:4px 0; border-bottom:1px solid var(--border); }
.vel-card .vrow:last-child { border-bottom:none; }
.vel-card .vrow .vl { color:var(--muted); }
.vel-card .sparkline { margin-top:12px; height:40px; display:flex; align-items:end; gap:2px; }
.vel-card .sparkline .bar { flex:1; border-radius:1px 1px 0 0; min-width:4px; transition:height .3s; }

/* ── CHARTS ─────────────────────────────────── */
.chart-container { background:var(--card); border:1px solid var(--border); padding:20px; border-radius:3px; margin-bottom:28px; min-height:200px; }
.chart-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
.chart-header h3 { font-family:var(--mono); font-size:10px; letter-spacing:3px; color:var(--muted); }
.chart-toggle { display:flex; gap:0; }
.chart-toggle button { background:var(--surface); border:1px solid var(--border); color:var(--muted); font-family:var(--mono); font-size:9px; letter-spacing:2px; padding:6px 12px; cursor:pointer; }
.chart-toggle button:first-child { border-radius:2px 0 0 2px; }
.chart-toggle button:last-child { border-radius:0 2px 2px 0; }
.chart-toggle button.active { background:var(--accent); color:#000; border-color:var(--accent); }

/* ── TABLES (products, budtenders, etc.) ────── */
.data-table { width:100%; border-collapse:collapse; font-family:var(--mono); font-size:11px; }
.data-table th { background:var(--surface); color:var(--muted); font-size:9px; letter-spacing:2px; text-transform:uppercase; padding:10px 12px; text-align:left; border-bottom:1px solid var(--border); }
.data-table td { padding:10px 12px; border-bottom:1px solid var(--border); }
.data-table tr:hover td { background:rgba(0,229,160,.03); }

/* ── LOADING / ERROR ────────────────────────── */
.loading { text-align:center; padding:60px; font-family:var(--mono); font-size:12px; color:var(--muted); letter-spacing:3px; }
.loading::after { content:''; display:block; width:40px; height:2px; background:var(--accent); margin:16px auto 0; animation:loadbar 1.5s infinite; }
@keyframes loadbar { 0%,100%{width:20px;opacity:.3} 50%{width:80px;opacity:1} }

/* ── RESPONSIVE ─────────────────────────────── */
@media(max-width:1024px) {
  .wrap { padding:20px; }
  .kpi-row { grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:12px; }
  .store-grid { grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); }
  .velocity-grid { grid-template-columns:1fr 1fr; }
}

@media(max-width:768px) {
  .wrap { padding:12px 10px; }

  /* Header — stack vertically */
  header { flex-direction:column; align-items:flex-start; gap:8px; padding-bottom:12px; margin-bottom:16px; }
  .logo h1 { font-size:32px; letter-spacing:4px; }
  .logo p { font-size:8px; letter-spacing:2px; }
  .header-right { width:100%; display:flex; align-items:center; justify-content:space-between; }
  .header-right .hdate { font-size:9px; }
  .header-right .hstatus { gap:6px; }

  /* Nav tabs — scrollable horizontal */
  .nav-tabs { overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; gap:0; margin-bottom:16px; flex-wrap:nowrap; }
  .nav-tabs::-webkit-scrollbar { display:none; }
  .nav-tabs button { font-size:9px; letter-spacing:1px; padding:10px 12px; white-space:nowrap; flex-shrink:0; }

  /* KPIs — 2 columns, smaller */
  .kpi-row { grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px; }
  .kpi { padding:12px; }
  .kpi .label { font-size:7px; letter-spacing:2px; margin-bottom:4px; }
  .kpi .value { font-size:18px; }
  .kpi .sub { font-size:8px; margin-top:4px; }
  .kpi .change { font-size:9px; }

  /* Section titles */
  .section-title { font-size:8px; letter-spacing:2px; margin:20px 0 10px; }

  /* Store grid — 2 columns */
  .store-grid { grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px; }
  .store-card { padding:10px; }
  .store-card .sname { font-size:12px; }
  .store-card .sval { font-size:15px; }
  .store-card .schange { font-size:9px; }

  /* Heatmap — scrollable with sticky first column */
  .heatmap-wrap { margin-bottom:16px; -webkit-overflow-scrolling:touch; }
  .heatmap-table th, .heatmap-table td { padding:6px 5px; font-size:9px; min-width:70px; }
  .heatmap-table th:first-child, .heatmap-table td:first-child { position:sticky; left:0; z-index:3; min-width:80px; }

  /* Store selector — horizontal scroll */
  .store-selector { flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; padding-bottom:4px; }
  .store-selector::-webkit-scrollbar { display:none; }
  .store-selector button { font-size:9px; padding:6px 10px; white-space:nowrap; flex-shrink:0; }

  /* Velocity cards — single column */
  .velocity-grid { grid-template-columns:1fr; gap:12px; }
  .vel-card { padding:14px; }
  .vel-card .vname { font-size:14px; }
  .vel-card .vrow { font-size:10px; }

  /* Charts — reduce height */
  .chart-container { padding:12px; margin-bottom:16px; min-height:140px; }
  .chart-header h3 { font-size:8px; letter-spacing:2px; }

  /* Data tables — scrollable */
  .data-table { font-size:9px; }
  .data-table th { font-size:8px; padding:8px 6px; }
  .data-table td { padding:8px 6px; }

  /* Rankings grid — single column on mobile */
  #rankingsSection > div { grid-template-columns:1fr !important; }

  /* Chart bar labels — rotate on mobile */
  .bar-label {
    font-size:8px !important;
    writing-mode:vertical-rl;
    text-orientation:mixed;
    transform:translateX(-50%) rotate(180deg) !important;
    top:auto !important;
    bottom:4px !important;
    line-height:1;
  }
  .bar-date { font-size:7px !important; }
  .bar-wrap { gap:2px !important; }

  /* Day vs Day buttons */
  #dowSelector button { font-size:10px; padding:8px 10px; min-width:40px !important; }

  /* Login */
  .login-box { padding:32px 20px; margin:0 16px; }
  .login-box h1 { font-size:40px; letter-spacing:4px; }

  /* Footer */
  footer { font-size:8px !important; }
}

@media(max-width:400px) {
  .kpi-row { grid-template-columns:1fr; }
  .store-grid { grid-template-columns:1fr; }
  .kpi .value { font-size:20px; }
  .nav-tabs button { font-size:8px; padding:8px 8px; }
}

/* ── ANIMATIONS ─────────────────────────────── */
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.fade-in { animation:fadeIn .4s ease both; }
.fade-in-1 { animation-delay:.05s; }
.fade-in-2 { animation-delay:.1s; }
.fade-in-3 { animation-delay:.15s; }
.fade-in-4 { animation-delay:.2s; }
.fade-in-5 { animation-delay:.25s; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <h1>THRIVE</h1>
    <p>EXECUTIVE INTELLIGENCE PLATFORM</p>
    <input type="password" id="loginKey" placeholder="ENTER ACCESS KEY" autocomplete="off">
    <button onclick="doLogin()">ENTER</button>
    <div class="login-error" id="loginError">INVALID KEY — TRY AGAIN</div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="wrap" id="dashboard" style="display:none">
  <header>
    <div class="logo">
      <h1>THRIVE</h1>
      <p>CANNABIS MARKETPLACE — EXECUTIVE INTELLIGENCE</p>
    </div>
    <div class="header-right">
      <div class="hdate" id="headerDate"></div>
      <div class="hstatus">
        <span class="pill live" id="statusPill">● LIVE</span>
        <button class="refresh-btn" onclick="refreshData()">↻ REFRESH</button>
        <span style="font-family:var(--mono);font-size:10px;color:var(--muted)" id="lastSync"></span>
      </div>
    </div>
  </header>

  <div class="nav-tabs" id="navTabs">
    <button class="active" data-tab="executive">Executive</button>
    <button data-tab="heatmap">Heatmap</button>
    <button data-tab="dayvday">Day vs Day</button>
    <button data-tab="stores">Stores</button>
    <button data-tab="velocity">Velocity</button>
    <button data-tab="budtenders">Budtenders</button>
    <button data-tab="range">Custom Range</button>
  </div>

  <!-- TAB: EXECUTIVE -->
  <div id="tab-executive" class="tab-content">
    <div class="kpi-row" id="execKpis"></div>
    <div class="section-title"><span>◆</span> THIS WEEK — STORE PERFORMANCE</div>
    <div class="store-grid" id="storeGrid"></div>
    <div class="section-title"><span>◆</span> WEEKLY TREND — <span id="trendWeeksLabel">12 WEEKS</span></div>
    <div class="chart-container" id="trendChart">
      <div class="loading">LOADING TREND DATA</div>
    </div>
    <div class="section-title"><span>◆</span> STORE RANKINGS</div>
    <div id="rankingsSection"></div>
  </div>

  <!-- TAB: HEATMAP -->
  <div id="tab-heatmap" class="tab-content" style="display:none">
    <div class="section-title"><span>◆</span> WEEK-OVER-WEEK HEATMAP — <span>NET SALES</span></div>
    <div class="heatmap-wrap" id="heatmapWrap">
      <div class="loading">LOADING HEATMAP</div>
    </div>
  </div>

  <!-- TAB: DAY VS DAY -->
  <div id="tab-dayvday" class="tab-content" style="display:none">
    <div class="section-title"><span>◆</span> DAY VS DAY — SAME WEEKDAY COMPARISON</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px;" id="dowSelector">
      <button class="refresh-btn" data-dow="1" style="min-width:50px">MON</button>
      <button class="refresh-btn" data-dow="2" style="min-width:50px">TUE</button>
      <button class="refresh-btn" data-dow="3" style="min-width:50px">WED</button>
      <button class="refresh-btn" data-dow="4" style="min-width:50px">THU</button>
      <button class="refresh-btn" data-dow="5" style="min-width:50px">FRI</button>
      <button class="refresh-btn" data-dow="6" style="min-width:50px">SAT</button>
      <button class="refresh-btn" data-dow="0" style="min-width:50px">SUN</button>
    </div>
    <div id="dvdContent">
      <div class="loading">SELECT A DAY ABOVE</div>
    </div>
  </div>

  <!-- TAB: STORES -->
  <div id="tab-stores" class="tab-content" style="display:none">
    <div class="store-selector" id="storeSelector"></div>
    <div id="storeDetailContent">
      <div class="loading">SELECT A STORE</div>
    </div>
  </div>

  <!-- TAB: VELOCITY -->
  <div id="tab-velocity" class="tab-content" style="display:none">
    <div class="section-title"><span>◆</span> STORE VELOCITY — 4-WEEK ROLLING ANALYSIS</div>
    <div class="velocity-grid" id="velocityGrid">
      <div class="loading">LOADING VELOCITY DATA</div>
    </div>
  </div>

  <!-- TAB: BUDTENDERS -->
  <div id="tab-budtenders" class="tab-content" style="display:none">
    <div class="section-title"><span>◆</span> BUDTENDER PERFORMANCE — LAST WEEK</div>
    <div class="store-selector" id="btStoreSelector"></div>
    <div id="btContent">
      <div class="loading">SELECT A STORE</div>
    </div>
  </div>

  <!-- TAB: CUSTOM RANGE -->
  <div id="tab-range" class="tab-content" style="display:none">
    <div class="section-title"><span>◆</span> CUSTOM RANGE — COMPARE & ANALYZE</div>

    <!-- Range A -->
    <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px;">
      <div style="flex:1;min-width:280px;">
        <div style="font-family:var(--mono);font-size:9px;letter-spacing:2px;color:var(--accent);margin-bottom:6px;font-weight:700;">RANGE A (PRIMARY)</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <input type="date" id="rangeAStart" style="background:var(--surface);border:1px solid var(--accent);color:var(--text);font-family:var(--mono);font-size:12px;padding:8px 12px;border-radius:2px;">
          <span style="color:var(--muted);font-family:var(--mono);font-size:11px;">→</span>
          <input type="date" id="rangeAEnd" style="background:var(--surface);border:1px solid var(--accent);color:var(--text);font-family:var(--mono);font-size:12px;padding:8px 12px;border-radius:2px;">
        </div>
      </div>
      <div style="flex:1;min-width:280px;">
        <div style="font-family:var(--mono);font-size:9px;letter-spacing:2px;color:var(--muted);margin-bottom:6px;font-weight:700;">RANGE B (COMPARE)</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <input type="date" id="rangeBStart" style="background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:12px;padding:8px 12px;border-radius:2px;">
          <span style="color:var(--muted);font-family:var(--mono);font-size:11px;">→</span>
          <input type="date" id="rangeBEnd" style="background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:12px;padding:8px 12px;border-radius:2px;">
          <label style="font-family:var(--mono);font-size:10px;color:var(--muted);display:flex;align-items:center;gap:4px;">
            <input type="checkbox" id="rangeBEnabled" checked style="accent-color:var(--accent);"> Compare
          </label>
        </div>
      </div>
    </div>

    <!-- Quick presets + Run -->
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:20px;">
      <button onclick="runCustomRange()" style="background:var(--accent);color:#000;border:none;font-family:var(--mono);font-size:11px;letter-spacing:2px;padding:10px 24px;cursor:pointer;font-weight:700;border-radius:2px;">RUN REPORT</button>
      <button onclick="setQuickRange('week')" class="refresh-btn">THIS WEEK</button>
      <button onclick="setQuickRange('lastweek')" class="refresh-btn">LAST WEEK</button>
      <button onclick="setQuickRange('30d')" class="refresh-btn">LAST 30D</button>
      <button onclick="setQuickRange('ytd')" class="refresh-btn">YTD</button>
      <button onclick="setQuickRange('lastyear')" class="refresh-btn">LAST YEAR</button>
      <button onclick="setQuickRange('monthvmonth')" class="refresh-btn">THIS MONTH vs LAST</button>
    </div>

    <div id="rangeResults"></div>
  </div>

  <!-- FOOTER -->
  <footer style="margin-top:60px;padding:20px 0;border-top:1px solid var(--border);text-align:center;">
    <span style="font-family:var(--mono);font-size:9px;letter-spacing:3px;color:var(--muted);">THRIVE CANNABIS — EXECUTIVE INTELLIGENCE • <span id="footerStores">7</span> LOCATIONS • LAST SYNC <span id="footerSync"></span></span>
  </footer>
</div>

<script>
// ═══════════════════════════════════════════════════════════════
// THRIVE DASHBOARD — CLIENT
// ═══════════════════════════════════════════════════════════════

let API_KEY = '';
let dashboardData = null;
let trendData = null;
let stores = [];

// ── Helpers ──────────────────────────────────────────────────
const fmt = (v) => v == null ? '—' : '$' + Number(v).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const fmtK = (v) => {
  if (v == null) return '—';
  return '$' + Number(v).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
};
const pctChange = (curr, prev) => {
  if (!curr || !prev || prev === 0) return null;
  return ((curr - prev) / prev * 100);
};
const pctFmt = (p) => {
  if (p == null) return '—';
  const sign = p >= 0 ? '▲' : '▼';
  return `${sign}${Math.abs(p).toFixed(1)}%`;
};
const pctClass = (p) => p == null ? '' : p >= 0 ? 'up' : 'down';

async function api(path) {
  const sep = path.includes('?') ? '&' : '?';
  const res = await fetch(path + sep + 'key=' + encodeURIComponent(API_KEY));
  if (res.status === 401) throw new Error('Unauthorized');
  if (!res.ok) throw new Error(`API ${res.status}`);
  return res.json();
}

// ── Login ───────────────────────────────────────────────────
function doLogin() {
  API_KEY = document.getElementById('loginKey').value.trim();
  if (!API_KEY) return;
  fetch('/health').then(r => r.json()).then(async () => {
    try {
      stores = await api('/api/stores');
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      initDashboard();
    } catch (e) {
      document.getElementById('loginError').style.display = 'block';
    }
  }).catch(() => {
    document.getElementById('loginError').textContent = 'SERVER OFFLINE';
    document.getElementById('loginError').style.display = 'block';
  });
}
document.getElementById('loginKey').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

// ── Init ────────────────────────────────────────────────────
function initDashboard() {
  const now = new Date();
  document.getElementById('headerDate').textContent = now.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' }).toUpperCase();

  // Custom range defaults: Range A = this week, Range B = last week
  const todayStr = now.toISOString().split('T')[0];
  const dowNow = now.getDay();
  const monA = new Date(now); monA.setDate(now.getDate() - ((dowNow + 6) % 7));
  const sunA = new Date(monA); sunA.setDate(monA.getDate() + 6);
  const monB = new Date(monA); monB.setDate(monA.getDate() - 7);
  const sunB = new Date(monB); sunB.setDate(monB.getDate() + 6);
  const d2s = d => d.toISOString().split('T')[0];
  document.getElementById('rangeAStart').value = d2s(monA);
  document.getElementById('rangeAEnd').value = d2s(sunA);
  document.getElementById('rangeBStart').value = d2s(monB);
  document.getElementById('rangeBEnd').value = d2s(sunB);

  // Tab navigation
  document.querySelectorAll('#navTabs button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#navTabs button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).style.display = 'block';
      if (btn.dataset.tab === 'heatmap' && !trendData) loadTrend();
      if (btn.dataset.tab === 'velocity' && !trendData) loadTrend();
    });
  });

  // Build store selectors
  buildStoreSelectors();

  // Day vs Day selector
  document.querySelectorAll('#dowSelector button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#dowSelector button').forEach(b => {
        b.style.background = 'var(--card)'; b.style.color = 'var(--muted)'; b.style.borderColor = 'var(--border)';
      });
      btn.style.background = 'var(--accent)'; btn.style.color = '#000'; btn.style.borderColor = 'var(--accent)';
      loadDayVsDay(parseInt(btn.dataset.dow));
    });
  });

  loadDashboard();
  loadTrend();
}

function buildStoreSelectors() {
  ['storeSelector', 'btStoreSelector'].forEach(id => {
    const el = document.getElementById(id);
    el.innerHTML = stores.map(s =>
      `<button data-store="${s.id}" style="border-left:3px solid ${s.color}">${s.name}</button>`
    ).join('');
    el.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        el.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (id === 'storeSelector') loadStoreDetail(btn.dataset.store);
        if (id === 'btStoreSelector') loadBudtenders(btn.dataset.store);
      });
    });
  });
}

// ── Load dashboard data ─────────────────────────────────────
async function loadDashboard() {
  try {
    dashboardData = await api('/api/dashboard');
    renderExecutive();
    updateSyncTime();
  } catch (e) {
    console.error('Dashboard load failed:', e);
    document.getElementById('statusPill').className = 'pill error';
    document.getElementById('statusPill').textContent = '● ERROR';
  }
}

async function loadTrend() {
  try {
    const raw = await api('/api/trend?weeks=12');

    // Handle "building" status — show loading, retry in 10s
    if (raw.status === 'building') {
      document.getElementById('trendChart').innerHTML = '<div class="loading">BUILDING TREND CACHE... REFRESH IN ~60s</div>';
      setTimeout(loadTrend, 10000);
      return;
    }

    // Normalize Redis format → array of { store, trend }
    if (raw.stores && !Array.isArray(raw)) {
      trendData = Object.entries(raw.stores).map(([id, st]) => ({
        store: { id, name: st.name, color: st.color },
        trend: (st.weeks || []).map(w => ({
          week: { start: w.week, end: w.weekEnd },
          summary: w.summary,
          error: w.error,
        })),
      }));
    } else {
      trendData = raw; // old array format
    }

    renderTrendChart();
    renderHeatmap();
    renderVelocity();
  } catch (e) {
    console.error('Trend load failed:', e);
    document.getElementById('trendChart').innerHTML = '<div class="loading" style="color:var(--red)">TREND DATA UNAVAILABLE</div>';
  }
}

async function refreshData() {
  await fetch('/api/cache/clear', { method:'POST', headers:{ 'Authorization':'Bearer '+API_KEY } }).catch(()=>{});
  loadDashboard();
  loadTrend();
}

function updateSyncTime() {
  const t = new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  document.getElementById('lastSync').textContent = 'SYNCED ' + t;
  document.getElementById('footerSync').textContent = t;
  document.getElementById('footerStores').textContent = stores.length;
}

// ═══════════════════════════════════════════════════════════════
// EXECUTIVE TAB
// ═══════════════════════════════════════════════════════════════
function renderExecutive() {
  if (!dashboardData) return;
  const d = dashboardData;
  const storeData = d.stores || [];

  // Aggregate
  const todayTotal = storeData.reduce((s, st) => s + (st.today?.net_sales || 0), 0);
  const twTotal = storeData.reduce((s, st) => s + (st.thisWeek?.net_sales || 0), 0);
  const lwTotal = storeData.reduce((s, st) => s + (st.lastWeek?.net_sales || 0), 0);
  const twTxn = storeData.reduce((s, st) => s + (st.today?.transaction_count || 0), 0);
  const twAvgBasket = twTxn > 0 ? todayTotal / twTxn : 0;
  const wowPct = pctChange(twTotal, lwTotal);

  // Week leader
  let leader = storeData.reduce((best, st) => {
    const val = st.thisWeek?.net_sales || 0;
    return val > (best?.thisWeek?.net_sales || 0) ? st : best;
  }, storeData[0]);

  // KPIs — no WoW% on current week since it's partial/in-progress
  const kpis = [
    { label: 'TODAY (ALL STORES)', value: fmtK(todayTotal), sub: `${twTxn} transactions • Live` },
    { label: 'THIS WEEK (IN PROGRESS)', value: fmtK(twTotal), sub: `${d.meta.dateRanges.thisWeek.start} → ${d.meta.dateRanges.thisWeek.end}` },
    { label: 'LAST WEEK', value: fmtK(lwTotal), sub: 'Completed week total' },
    { label: 'AVG BASKET (TODAY)', value: fmt(twAvgBasket), sub: `${twTxn} transactions` },
    { label: 'WEEK LEADER', value: leader?.name || '—', sub: fmtK(leader?.thisWeek?.net_sales) + ' this week', isText: true },
  ];

  document.getElementById('execKpis').innerHTML = kpis.map((k, i) => `
    <div class="kpi fade-in fade-in-${i+1}">
      <div class="label">${k.label}</div>
      <div class="value" ${k.isText ? 'style="font-size:20px;letter-spacing:1px"' : ''}>${k.value}</div>
      <div class="sub">${k.sub}</div>
      ${k.change != null ? `<div class="change ${pctClass(k.change)}">${pctFmt(k.change)} ${k.changeLabel || ''}</div>` : ''}
    </div>
  `).join('');

  // Store grid — no WoW% since current week is partial
  document.getElementById('storeGrid').innerHTML = storeData.map(st => {
    const tw = st.thisWeek?.net_sales || 0;
    const lw = st.lastWeek?.net_sales || 0;
    const color = stores.find(s => s.id === st.id)?.color || '#888';
    return `
      <div class="store-card" style="border-left-color:${color}" onclick="switchToStore('${st.id}')">
        <div class="sname">${st.name}</div>
        <div class="sval">${fmtK(tw)}</div>
        <div style="font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:4px;">LW: ${fmtK(lw)}</div>
      </div>
    `;
  }).join('');

  // Rankings
  renderRankings(storeData);
}

function renderRankings(storeData) {
  // Revenue ranking
  const byRev = [...storeData].sort((a, b) => (b.thisWeek?.net_sales || 0) - (a.thisWeek?.net_sales || 0));
  // Momentum: use trend data for last 2 COMPLETED weeks if available, else skip
  let byMom = [];
  if (trendData && trendData.length > 0) {
    byMom = storeData.map(st => {
      const storeTrend = trendData.find(t => t.store.id === st.id);
      const trend = storeTrend?.trend || [];
      // Last completed week = second to last (last is current/partial)
      const lw = trend.length >= 2 ? trend[trend.length - 2]?.summary?.net_sales : null;
      const w2 = trend.length >= 3 ? trend[trend.length - 3]?.summary?.net_sales : null;
      return { ...st, wow: pctChange(lw, w2), lwSales: lw };
    }).sort((a, b) => (b.wow || -999) - (a.wow || -999));
  } else {
    // Fallback: just show last week revenue, no %
    byMom = [...storeData].map(st => ({ ...st, wow: null, lwSales: st.lastWeek?.net_sales }))
      .sort((a, b) => (b.lwSales || 0) - (a.lwSales || 0));
  }

  document.getElementById('rankingsSection').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div class="chart-container">
        <div class="chart-header"><h3>THIS WEEK REVENUE (IN PROGRESS)</h3></div>
        ${byRev.map((st, i) => {
          const val = st.thisWeek?.net_sales || 0;
          const maxVal = byRev[0]?.thisWeek?.net_sales || 1;
          const pct = (val / maxVal * 100).toFixed(0);
          const color = stores.find(s => s.id === st.id)?.color || '#888';
          return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
            <span style="font-weight:600;font-size:12px;width:80px;white-space:nowrap;">${st.name}</span>
            <div style="flex:1;height:24px;background:var(--surface);border-radius:2px;overflow:hidden;position:relative;">
              <div style="height:100%;width:${pct}%;background:${color};border-radius:2px;transition:width .5s;"></div>
              <span style="position:absolute;top:50%;left:8px;transform:translateY(-50%);font-family:var(--mono);font-size:11px;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.5);">${fmtK(val)}</span>
            </div>
          </div>`;
        }).join('')}
      </div>
      <div class="chart-container">
        <div class="chart-header"><h3>WoW MOMENTUM (COMPLETED WEEKS)</h3></div>
        ${(() => {
          const maxAbs = Math.max(...byMom.map(st => Math.abs(st.wow || 0)), 1);
          return byMom.map((st, i) => {
            const color = stores.find(s => s.id === st.id)?.color || '#888';
            const wow = st.wow || 0;
            const barWidth = Math.min(Math.abs(wow) / maxAbs * 45, 45);
            const isPos = wow >= 0;
            return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;height:24px;">
              <span style="font-weight:600;font-size:12px;width:80px;white-space:nowrap;">${st.name}</span>
              <div style="flex:1;display:flex;align-items:center;height:100%;">
                <div style="width:45%;display:flex;justify-content:flex-end;">
                  ${!isPos ? `<div style="height:20px;width:${barWidth}%;background:var(--red);border-radius:2px 0 0 2px;"></div>` : ''}
                </div>
                <div style="width:2px;height:100%;background:var(--border);flex-shrink:0;"></div>
                <div style="width:45%;display:flex;justify-content:flex-start;">
                  ${isPos ? `<div style="height:20px;width:${barWidth}%;background:var(--green);border-radius:0 2px 2px 0;"></div>` : ''}
                </div>
              </div>
              <span style="font-family:var(--mono);font-size:12px;font-weight:700;width:52px;text-align:right;color:${isPos ? 'var(--green)' : 'var(--red)'}">${pctFmt(wow)}</span>
              <span style="font-family:var(--mono);font-size:10px;color:var(--muted);width:85px;text-align:right;">${fmtK(st.lwSales)}</span>
            </div>`;
          }).join('');
        })()}
      </div>
    </div>
  `;
}

function switchToStore(storeId) {
  document.querySelectorAll('#navTabs button').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
  document.querySelector('#navTabs button[data-tab="stores"]').classList.add('active');
  document.getElementById('tab-stores').style.display = 'block';
  document.querySelectorAll('#storeSelector button').forEach(b => {
    b.classList.toggle('active', b.dataset.store === storeId);
  });
  loadStoreDetail(storeId);
}

// ═══════════════════════════════════════════════════════════════
// TREND CHART (simple bar chart via HTML/CSS)
// ═══════════════════════════════════════════════════════════════
function renderTrendChart() {
  if (!trendData) return;

  // Compute weekly company totals
  const numWeeks = trendData[0]?.trend?.length || 0;
  const weeklyTotals = [];
  for (let w = 0; w < numWeeks; w++) {
    let total = 0;
    trendData.forEach(st => {
      total += st.trend[w]?.summary?.net_sales || 0;
    });
    const wk = trendData[0]?.trend[w]?.week;
    weeklyTotals.push({ total, week: wk });
  }

  const maxVal = Math.max(...weeklyTotals.map(w => w.total), 1);

  // Abbreviated format just for chart labels
  const chartFmt = (v) => {
    if (v >= 1000000) return '$' + (v/1000000).toFixed(1) + 'M';
    if (v >= 1000) return '$' + (v/1000).toFixed(0) + 'K';
    return '$' + Math.round(v);
  };

  const bars = weeklyTotals.map((w, i) => {
    const h = Math.max((w.total / maxVal * 180), 20).toFixed(0);
    const prev = i > 0 ? weeklyTotals[i-1].total : w.total;
    const change = pctChange(w.total, prev);
    const isLast = i === numWeeks - 1;
    const color = isLast ? 'var(--muted)' : (change != null && change >= 0 ? 'var(--accent)' : 'var(--red)');
    const label = w.week?.start?.slice(5) || '';
    return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:0;">
      <div style="width:90%;height:${h}px;background:${color};border-radius:3px 3px 0 0;transition:height .5s;opacity:${isLast ? '0.5' : '1'};position:relative;min-height:20px;cursor:default;" title="${fmtK(w.total)} (${pctFmt(change)})">
        <span class="bar-label" style="position:absolute;top:4px;left:50%;transform:translateX(-50%);font-family:var(--mono);font-size:12px;font-weight:800;color:#000;white-space:nowrap;">${chartFmt(w.total)}</span>
      </div>
      <span class="bar-date" style="font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:4px;">${label}</span>
    </div>`;
  }).join('');

  document.getElementById('trendChart').innerHTML = `
    <div class="chart-header">
      <h3>ALL STORES COMBINED — WEEKLY NET SALES</h3>
      <div style="font-family:var(--mono);font-size:10px;color:var(--muted);">${numWeeks} WEEKS</div>
    </div>
    <div class="bar-wrap" style="display:flex;align-items:end;height:240px;gap:6px;padding-top:10px;">${bars}</div>
    <div style="font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:8px;text-align:center;">
      Current week (rightmost) is partial — <span style="opacity:0.5">shown at 50% opacity</span>
    </div>
  `;
}

// ═══════════════════════════════════════════════════════════════
// HEATMAP TAB
// ═══════════════════════════════════════════════════════════════
function renderHeatmap() {
  if (!trendData) return;
  const numWeeks = trendData[0]?.trend?.length || 0;

  // Build header
  let html = '<table class="heatmap-table"><thead><tr><th>WEEK</th>';
  trendData.forEach(st => { html += `<th>${st.store.name}</th>`; });
  html += '<th>CO. TOTAL</th><th>WoW %</th></tr></thead><tbody>';

  for (let w = 0; w < numWeeks; w++) {
    const isCurrentWeek = w === numWeeks - 1;
    const wk = trendData[0]?.trend[w]?.week;
    const weekLabel = wk ? wk.start.slice(5) + ' → ' + wk.end.slice(5) : 'W' + (w+1);
    const rowStyle = isCurrentWeek ? 'opacity:0.6;' : '';
    html += `<tr style="${rowStyle}"><td>${weekLabel}${isCurrentWeek ? ' *' : ''}</td>`;

    let weekTotal = 0;
    let prevWeekTotal = 0;

    trendData.forEach(st => {
      const val = st.trend[w]?.summary?.net_sales || 0;
      const prev = w > 0 ? (st.trend[w-1]?.summary?.net_sales || 0) : val;
      // No WoW% for current partial week
      const change = (w > 0 && !isCurrentWeek) ? pctChange(val, prev) : null;
      weekTotal += val;
      if (w > 0) prevWeekTotal += (st.trend[w-1]?.summary?.net_sales || 0);

      const bg = heatColor(change);
      html += `<td style="background:${bg};color:var(--text);" title="${pctFmt(change)}">${fmtK(val)}</td>`;
    });

    // No WoW% for current partial week
    const wowTotal = (w > 0 && !isCurrentWeek) ? pctChange(weekTotal, prevWeekTotal) : null;
    const totalBg = heatColor(wowTotal);
    html += `<td style="background:${totalBg};font-weight:700;">${fmtK(weekTotal)}</td>`;
    if (isCurrentWeek) {
      html += '<td style="font-family:var(--mono);font-size:10px;color:var(--muted);">IN PROGRESS</td>';
    } else {
      html += `<td style="font-weight:700;color:${wowTotal != null && wowTotal >= 0 ? 'var(--green)' : 'var(--red)'}">${pctFmt(wowTotal)}</td>`;
    }
    html += '</tr>';
  }

  html += '</tbody></table>';
  html += '<div style="font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:8px;">* Current week is in progress — no WoW% calculated</div>';
  document.getElementById('heatmapWrap').innerHTML = html;
}

function heatColor(pct) {
  if (pct == null) return 'transparent';
  if (pct >= 10) return 'rgba(0,214,143,0.35)';
  if (pct >= 5)  return 'rgba(0,214,143,0.22)';
  if (pct >= 1)  return 'rgba(0,214,143,0.1)';
  if (pct >= -1) return 'transparent';
  if (pct >= -5) return 'rgba(255,71,87,0.1)';
  if (pct >= -10) return 'rgba(255,71,87,0.22)';
  return 'rgba(255,71,87,0.35)';
}

// ═══════════════════════════════════════════════════════════════
// DAY VS DAY TAB
// ═══════════════════════════════════════════════════════════════
let dvdCache = {};

async function loadDayVsDay(dow) {
  const el = document.getElementById('dvdContent');
  if (dvdCache[dow]) { renderDayVsDay(dvdCache[dow]); return; }

  el.innerHTML = '<div class="loading">LOADING — COMPARING LAST 4 ' + ['SUNDAYS','MONDAYS','TUESDAYS','WEDNESDAYS','THURSDAYS','FRIDAYS','SATURDAYS'][dow] + '</div>';

  try {
    const data = await api('/api/day-vs-day?dow=' + dow + '&weeks=4');
    dvdCache[dow] = data;
    renderDayVsDay(data);
  } catch (e) {
    el.innerHTML = '<div class="loading" style="color:var(--red)">ERROR: ' + e.message + '</div>';
  }
}

function renderDayVsDay(data) {
  const el = document.getElementById('dvdContent');
  const dates = data.dates || [];
  if (dates.length === 0) { el.innerHTML = '<div class="loading">NO DATA</div>'; return; }

  // Format dates nicely
  const fmtDate = (d) => {
    const dt = new Date(d + 'T12:00:00');
    return dt.toLocaleDateString('en-US', { month:'short', day:'numeric' });
  };

  // ── HEATMAP TABLE ──
  let html = '<div class="section-title" style="margin-top:0"><span>◆</span> ' + data.dayName.toUpperCase() + ' — LAST ' + dates.length + ' WEEKS (NET SALES)</div>';
  html += '<div class="heatmap-wrap"><table class="heatmap-table"><thead><tr><th>DATE</th>';
  stores.forEach(s => { html += `<th>${s.name}</th>`; });
  html += '<th>CO. TOTAL</th><th>vs PREV</th></tr></thead><tbody>';

  dates.forEach((day, di) => {
    html += `<tr><td style="font-weight:700">${fmtDate(day.date)}</td>`;
    let dayTotal = 0;
    let prevDayTotal = 0;

    day.stores.forEach((st, si) => {
      const val = st.summary?.net_sales || 0;
      const prev = di < dates.length - 1 ? (dates[di + 1]?.stores[si]?.summary?.net_sales || 0) : null;
      const change = prev != null ? pctChange(val, prev) : null;
      dayTotal += val;
      if (di < dates.length - 1) prevDayTotal += (dates[di + 1]?.stores[si]?.summary?.net_sales || 0);

      const bg = heatColor(change);
      html += `<td style="background:${bg}" title="${pctFmt(change)}">${fmtK(val)}</td>`;
    });

    const totalChange = di < dates.length - 1 ? pctChange(dayTotal, prevDayTotal) : null;
    const totalBg = heatColor(totalChange);
    html += `<td style="background:${totalBg};font-weight:700">${fmtK(dayTotal)}</td>`;
    html += `<td style="font-weight:600;color:${totalChange != null && totalChange >= 0 ? 'var(--green)' : 'var(--red)'}">${pctFmt(totalChange)}</td>`;
    html += '</tr>';
  });

  html += '</tbody></table></div>';

  // ── PER-STORE COMPARISON CARDS ──
  html += '<div class="section-title"><span>◆</span> STORE-BY-STORE — ' + data.dayName.toUpperCase() + ' TREND</div>';
  html += '<div class="velocity-grid">';

  stores.forEach((s, si) => {
    const vals = dates.map(d => d.stores[si]?.summary?.net_sales || 0);
    const txns = dates.map(d => d.stores[si]?.summary?.transaction_count || 0);
    const avgSales = vals.length > 0 ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
    const latest = vals[0] || 0;
    const prev = vals[1] || 0;
    const change = pctChange(latest, prev);
    const maxVal = Math.max(...vals, 1);

    html += `<div class="vel-card">
      <div class="vname">
        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${s.color}"></span>
        ${s.name}
        <span class="vstatus ${pctClass(change)}" style="font-family:var(--mono);font-size:12px;font-weight:600">${pctFmt(change)}</span>
      </div>
      <div class="vrow"><span class="vl">MOST RECENT (${fmtDate(dates[0]?.date)})</span><span style="font-weight:700">${fmtK(latest)}</span></div>
      <div class="vrow"><span class="vl">PREVIOUS (${dates[1] ? fmtDate(dates[1].date) : '—'})</span><span>${fmtK(prev)}</span></div>
      <div class="vrow"><span class="vl">4-${data.dayName.toUpperCase()} AVG</span><span>${fmtK(avgSales)}</span></div>
      <div class="sparkline">${vals.reverse().map(v => {
        const h = Math.max((v / maxVal * 36), 2);
        return `<div class="bar" style="height:${h}px;background:${s.color};opacity:0.7;flex:1"></div>`;
      }).join('')}</div>
      <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:8px;color:var(--muted);margin-top:4px;">
        <span>${dates[dates.length-1] ? fmtDate(dates[dates.length-1].date) : ''}</span>
        <span>${fmtDate(dates[0]?.date)}</span>
      </div>
    </div>`;
  });

  html += '</div>';

  // ── TRANSACTION COUNT + AVG BASKET COMPARISON ──
  html += '<div class="section-title"><span>◆</span> TRANSACTIONS & BASKET SIZE — ' + data.dayName.toUpperCase() + '</div>';
  html += '<div class="heatmap-wrap"><table class="heatmap-table"><thead><tr><th>DATE</th>';
  stores.forEach(s => { html += `<th>${s.name} TXN</th><th>${s.name} BASKET</th>`; });
  html += '</tr></thead><tbody>';

  dates.forEach((day, di) => {
    html += `<tr><td style="font-weight:700">${fmtDate(day.date)}</td>`;
    day.stores.forEach((st, si) => {
      const txn = st.summary?.transaction_count || 0;
      const basket = st.summary?.avg_basket || 0;
      const prevTxn = di < dates.length - 1 ? (dates[di+1]?.stores[si]?.summary?.transaction_count || 0) : null;
      const prevBasket = di < dates.length - 1 ? (dates[di+1]?.stores[si]?.summary?.avg_basket || 0) : null;
      const txnChange = prevTxn ? pctChange(txn, prevTxn) : null;
      const basketChange = prevBasket ? pctChange(basket, prevBasket) : null;

      html += `<td style="background:${heatColor(txnChange)}">${txn}</td>`;
      html += `<td style="background:${heatColor(basketChange)}">${fmt(basket)}</td>`;
    });
    html += '</tr>';
  });

  html += '</tbody></table></div>';

  el.innerHTML = html;
}

// ═══════════════════════════════════════════════════════════════
// STORE DETAIL TAB
// ═══════════════════════════════════════════════════════════════
async function loadStoreDetail(storeId) {
  const el = document.getElementById('storeDetailContent');
  el.innerHTML = '<div class="loading">LOADING STORE DATA</div>';

  const storeInfo = stores.find(s => s.id === storeId);
  if (!storeInfo) { el.innerHTML = '<div class="loading">STORE NOT FOUND</div>'; return; }

  // Get store data from dashboard
  const sd = dashboardData?.stores?.find(s => s.id === storeId);
  const tw = sd?.thisWeek;
  const lw = sd?.lastWeek;
  const td = sd?.today;

  // WoW using last 2 completed weeks from trend (not partial current week)
  let storeWow = null;
  const stTrendRef = trendData?.find(st => st.store.id === storeId);
  if (stTrendRef?.trend?.length >= 3) {
    const lwVal = stTrendRef.trend[stTrendRef.trend.length - 2]?.summary?.net_sales;
    const w2Val = stTrendRef.trend[stTrendRef.trend.length - 3]?.summary?.net_sales;
    storeWow = pctChange(lwVal, w2Val);
  }

  // Get trend for this store
  let storeTrend = null;
  const stTrend = trendData?.find(st => st.store.id === storeId);
  if (stTrend) storeTrend = stTrend.trend;

  // Build KPIs — no WoW% on partial current week
  const kpis = [
    { label: 'TODAY', value: fmtK(td?.net_sales), sub: `${td?.transaction_count || 0} txns` },
    { label: 'THIS WEEK (IN PROGRESS)', value: fmtK(tw?.net_sales), sub: `${tw?.transaction_count || 0} txns` },
    { label: 'LAST WEEK', value: fmtK(lw?.net_sales), sub: `${lw?.transaction_count || 0} txns`, change: storeWow, changeLabel: 'vs prior week' },
    { label: 'AVG BASKET (TW)', value: fmt(tw?.avg_basket), sub: `${tw?.transaction_count || 0} txns` },
  ];

  let html = `<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
    <div style="width:4px;height:32px;background:${storeInfo.color};border-radius:2px;"></div>
    <h2 style="font-weight:800;font-size:28px;letter-spacing:2px;">${storeInfo.name.toUpperCase()}</h2>
  </div>`;

  html += `<div class="kpi-row">${kpis.map(k => `
    <div class="kpi">
      <div class="label">${k.label}</div>
      <div class="value">${k.value}</div>
      ${k.sub ? `<div class="sub">${k.sub}</div>` : ''}
      ${k.change != null ? `<div class="change ${pctClass(k.change)}">${pctFmt(k.change)} ${k.changeLabel || ''}</div>` : ''}
    </div>
  `).join('')}</div>`;

  // Weekly bars — match exec style: labels inside bars, neutral current week
  if (storeTrend && storeTrend.length > 0) {
    const maxVal = Math.max(...storeTrend.map(w => w.summary?.net_sales || 0), 1);
    const chartFmtStore = (v) => {
      if (v >= 1000000) return '$' + (v/1000000).toFixed(1) + 'M';
      if (v >= 1000) return '$' + (v/1000).toFixed(0) + 'K';
      return '$' + Math.round(v);
    };
    const bars = storeTrend.map((w, i) => {
      const val = w.summary?.net_sales || 0;
      const prev = i > 0 ? (storeTrend[i-1]?.summary?.net_sales || 0) : val;
      const ch = i > 0 ? pctChange(val, prev) : null;
      const isLast = i === storeTrend.length - 1;
      const color = isLast ? 'var(--muted)' : (ch != null && ch >= 0 ? storeInfo.color : 'var(--red)');
      const h = Math.max((val / maxVal * 160), 20).toFixed(0);
      const label = w.week?.start?.slice(5) || '';
      return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:0;">
        <div style="width:90%;height:${h}px;background:${color};border-radius:3px 3px 0 0;opacity:${isLast?'0.5':'1'};position:relative;min-height:20px;" title="${fmtK(val)} (${pctFmt(ch)})">
          <span class="bar-label" style="position:absolute;top:3px;left:50%;transform:translateX(-50%);font-family:var(--mono);font-size:10px;font-weight:800;color:#000;white-space:nowrap;">${chartFmtStore(val)}</span>
        </div>
        <span class="bar-date" style="font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:4px;">${label}</span>
      </div>`;
    }).join('');

    html += `<div class="chart-container">
      <div class="chart-header"><h3>${storeInfo.name.toUpperCase()} — 12-WEEK TREND</h3></div>
      <div class="bar-wrap" style="display:flex;align-items:end;height:200px;gap:4px;padding-top:10px;">${bars}</div>
      <div style="font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:8px;text-align:center;">Current week (rightmost) is partial</div>
    </div>`;
  }

  // ── HOURLY TRAFFIC HEATMAP + CATEGORY TRENDS (from Redis store detail) ──
  // Fetch async and append when ready
  el.innerHTML = html + '<div id="storeDetailExtra"><div class="loading">LOADING HOURLY & CATEGORY DATA...</div></div>';

  api(`/api/store-detail/${storeId}`).then(detail => {
    const extraEl = document.getElementById('storeDetailExtra');
    if (!extraEl) return;
    if (detail.status === 'building') {
      extraEl.innerHTML = '<div class="loading">BUILDING STORE ANALYTICS... REFRESH IN ~60s</div>';
      return;
    }

    let extraHtml = '';

    // ── BUSIEST TIMES HEATMAP ──
    if (detail.hourly) {
      const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      const hourly = detail.hourly;

      // Find operating hours range (first/last hour with any transactions)
      let minHour = 23, maxHour = 0;
      for (let d = 0; d < 7; d++) {
        for (let h = 0; h < 24; h++) {
          if (hourly[d] && hourly[d][h] && hourly[d][h].transactions > 0) {
            if (h < minHour) minHour = h;
            if (h > maxHour) maxHour = h;
          }
        }
      }
      if (minHour > maxHour) { minHour = 8; maxHour = 22; } // fallback
      minHour = Math.max(minHour - 1, 0);
      maxHour = Math.min(maxHour + 1, 23);

      // Find max for color scaling
      let maxTxn = 0;
      for (let d = 0; d < 7; d++) {
        for (let h = minHour; h <= maxHour; h++) {
          const t = hourly[d]?.[h]?.transactions || 0;
          if (t > maxTxn) maxTxn = t;
        }
      }

      // Find busiest single slot
      let peakDay = 0, peakHour = 0, peakTxn = 0;
      for (let d = 0; d < 7; d++) {
        for (let h = minHour; h <= maxHour; h++) {
          const t = hourly[d]?.[h]?.transactions || 0;
          if (t > peakTxn) { peakTxn = t; peakDay = d; peakHour = h; }
        }
      }

      // Find busiest day overall
      const dayTotals = dayNames.map((_, d) => {
        let sum = 0;
        for (let h = minHour; h <= maxHour; h++) sum += hourly[d]?.[h]?.transactions || 0;
        return sum;
      });
      const busiestDayIdx = dayTotals.indexOf(Math.max(...dayTotals));

      const fmtHour = (h) => {
        if (h === 0) return '12a';
        if (h < 12) return h + 'a';
        if (h === 12) return '12p';
        return (h - 12) + 'p';
      };

      const heatCellColor = (val) => {
        if (!val || val === 0) return 'rgba(255,255,255,0.02)';
        const intensity = Math.min(val / maxTxn, 1);
        // Low = dark teal, High = bright accent
        const r = Math.round(0 + intensity * 0);
        const g = Math.round(30 + intensity * 199);
        const b = Math.round(40 + intensity * 120);
        return 'rgba(' + r + ',' + g + ',' + b + ',' + (0.15 + intensity * 0.85) + ')';
      };

      extraHtml += '<div class="section-title"><span>◆</span> BUSIEST TIMES — LAST 4 WEEKS (AVG)</div>';
      extraHtml += '<div style="margin-bottom:8px;font-family:var(--mono);font-size:10px;color:var(--muted);">'
        + 'Peak: <span style="color:var(--accent);font-weight:700">' + dayNames[peakDay] + ' ' + fmtHour(peakHour) + '–' + fmtHour(peakHour+1) + '</span> (' + peakTxn + ' txns)'
        + ' &nbsp;·&nbsp; Busiest day: <span style="color:var(--accent);font-weight:700">' + dayNames[busiestDayIdx] + '</span> (' + dayTotals[busiestDayIdx] + ' txns)'
        + '</div>';

      extraHtml += '<div class="heatmap-wrap"><table class="data-table" style="text-align:center;"><thead><tr><th></th>';
      for (let h = minHour; h <= maxHour; h++) {
        extraHtml += '<th style="font-size:8px;padding:4px 2px;min-width:28px;">' + fmtHour(h) + '</th>';
      }
      extraHtml += '<th style="font-size:8px;padding:4px 6px;">TOTAL</th></tr></thead><tbody>';

      for (let d = 0; d < 7; d++) {
        extraHtml += '<tr><td style="font-weight:700;font-size:10px;padding:4px 6px;white-space:nowrap;">' + dayNames[d] + '</td>';
        let daySum = 0;
        for (let h = minHour; h <= maxHour; h++) {
          const t = hourly[d]?.[h]?.transactions || 0;
          daySum += t;
          const bg = heatCellColor(t);
          const isPeak = d === peakDay && h === peakHour;
          extraHtml += '<td style="background:' + bg + ';font-family:var(--mono);font-size:10px;font-weight:' + (t > 0 ? '600' : '400') + ';padding:4px 2px;color:' + (t > 0 ? '#fff' : 'var(--muted)') + ';min-width:28px;' + (isPeak ? 'outline:2px solid var(--accent);outline-offset:-2px;' : '') + '" title="' + dayNames[d] + ' ' + fmtHour(h) + ': ' + t + ' txns">' + (t || '·') + '</td>';
        }
        extraHtml += '<td style="font-family:var(--mono);font-size:10px;font-weight:700;padding:4px 6px;">' + daySum + '</td></tr>';
      }

      extraHtml += '</tbody></table></div>';
    }

    // ── CATEGORY TRENDS — LAST WEEK vs PRIOR WEEK ──
    if (detail.categoryTrend && detail.categoryTrend.length > 0) {
      const cats = detail.categoryTrend;
      const totalLW = cats.reduce((s, c) => s + c.lw_sales, 0);

      extraHtml += '<div class="section-title"><span>◆</span> CATEGORY TRENDS — LAST WEEK vs PRIOR</div>';
      extraHtml += '<table class="data-table"><thead><tr>'
        + '<th>CATEGORY</th><th>LAST WEEK</th><th>PRIOR WEEK</th><th>WoW</th><th>UNITS (LW)</th><th>SHARE</th>'
        + '</tr></thead><tbody>';

      cats.forEach(cat => {
        const share = totalLW > 0 ? (cat.lw_sales / totalLW * 100).toFixed(1) : 0;
        const wowColor = cat.wow_pct != null ? (cat.wow_pct >= 0 ? 'var(--green)' : 'var(--red)') : 'var(--muted)';
        const wowText = cat.wow_pct != null ? (cat.wow_pct >= 0 ? '+' : '') + cat.wow_pct.toFixed(1) + '%' : '—';
        const wowBg = cat.wow_pct != null ? (cat.wow_pct >= 5 ? 'rgba(0,229,160,0.08)' : cat.wow_pct <= -5 ? 'rgba(255,77,109,0.08)' : 'transparent') : 'transparent';
        extraHtml += '<tr style="background:' + wowBg + '">'
          + '<td style="font-weight:600">' + cat.name + '</td>'
          + '<td style="font-weight:700">' + fmtK(cat.lw_sales) + '</td>'
          + '<td style="color:var(--muted)">' + fmtK(cat.pw_sales) + '</td>'
          + '<td style="color:' + wowColor + ';font-weight:700">' + wowText + '</td>'
          + '<td>' + cat.lw_units + '</td>'
          + '<td>' + share + '%</td>'
          + '</tr>';
      });

      extraHtml += '</tbody></table>';
    }

    extraEl.innerHTML = extraHtml || '<div class="loading" style="color:var(--muted)">NO ADDITIONAL DATA</div>';
  }).catch(err => {
    const extraEl = document.getElementById('storeDetailExtra');
    if (extraEl) extraEl.innerHTML = '';
    console.error('Store detail extra failed:', err);
  });
}

// ═══════════════════════════════════════════════════════════════
// VELOCITY TAB
// ═══════════════════════════════════════════════════════════════
function renderVelocity() {
  if (!trendData) return;

  const cards = trendData.map(st => {
    const trend = st.trend || [];
    const storeInfo = stores.find(s => s.id === st.store.id) || st.store;

    // Exclude last (current/partial) week for all calculations
    const completed = trend.slice(0, -1);

    // 4-week rolling avg (most recent completed)
    const recent4 = completed.slice(-4).filter(w => w.summary);
    const prior4 = completed.slice(-8, -4).filter(w => w.summary);
    const recentAvg = recent4.length > 0 ? recent4.reduce((s, w) => s + (w.summary.net_sales || 0), 0) / recent4.length : 0;
    const priorAvg = prior4.length > 0 ? prior4.reduce((s, w) => s + (w.summary.net_sales || 0), 0) / prior4.length : 0;
    const rollingPct = pctChange(recentAvg, priorAvg);

    // Streak (completed weeks only)
    let streak = 0;
    let streakDir = null;
    for (let i = completed.length - 1; i > 0; i--) {
      const curr = completed[i]?.summary?.net_sales || 0;
      const prev = completed[i-1]?.summary?.net_sales || 0;
      const dir = curr >= prev ? 'up' : 'down';
      if (streakDir === null) streakDir = dir;
      if (dir === streakDir) streak++;
      else break;
    }

    // Status
    let status = '➖ FLAT';
    if (rollingPct > 5) status = '🔥 HOT';
    else if (rollingPct > 0) status = '📈 WARMING';
    else if (rollingPct < -5) status = '❄️ COOLING';
    else if (rollingPct < 0) status = '📉 SOFTENING';

    // Sparkline data (completed weeks only)
    const sparkVals = completed.map(w => w.summary?.net_sales || 0);
    const sparkMax = Math.max(...sparkVals, 1);

    return `<div class="vel-card">
      <div class="vname">
        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${storeInfo.color}"></span>
        ${storeInfo.name}
        <span class="vstatus">${status}</span>
      </div>
      <div class="vrow"><span class="vl">4-WK ROLLING AVG</span><span style="font-weight:700">${fmtK(recentAvg)}</span></div>
      <div class="vrow"><span class="vl">vs PRIOR 4-WK</span><span class="${pctClass(rollingPct)}" style="font-weight:600">${pctFmt(rollingPct)}</span></div>
      <div class="vrow"><span class="vl">STREAK</span><span>${streak}W ${streakDir === 'up' ? '▲' : '▼'}</span></div>
      <div class="vrow"><span class="vl">LAST COMPLETED WEEK</span><span style="font-weight:600">${fmtK(completed[completed.length-1]?.summary?.net_sales)}</span></div>
      <div class="sparkline">${sparkVals.map(v => {
        const h = Math.max((v / sparkMax * 36), 2);
        return `<div class="bar" style="height:${h}px;background:${storeInfo.color};opacity:0.7"></div>`;
      }).join('')}</div>
    </div>`;
  });

  document.getElementById('velocityGrid').innerHTML = cards.join('');
}

// ═══════════════════════════════════════════════════════════════
// BUDTENDERS TAB
// ═══════════════════════════════════════════════════════════════
// ── Budtender sort state ──────────────────────────────────────
let btSortCols = []; // array of { key, dir } where dir = 'asc' | 'desc'
let btRawData = [];  // raw employee array
let btTotalSales = 0;

function btToggleSort(key) {
  const idx = btSortCols.findIndex(s => s.key === key);
  if (idx === -1) {
    // Not sorted — add as desc
    btSortCols.push({ key, dir: 'desc' });
  } else if (btSortCols[idx].dir === 'desc') {
    // desc → asc
    btSortCols[idx].dir = 'asc';
  } else {
    // asc → remove (reset)
    btSortCols.splice(idx, 1);
  }
  renderBudtenderTable();
}

function btSortArrow(key) {
  const s = btSortCols.find(c => c.key === key);
  if (!s) return '';
  const priority = btSortCols.length > 1 ? `<span style="font-size:9px;opacity:0.5;margin-left:2px">${btSortCols.indexOf(s)+1}</span>` : '';
  return `<span style="margin-left:4px;color:var(--accent)">${s.dir === 'desc' ? '▼' : '▲'}</span>${priority}`;
}

function btGetValue(e, key) {
  switch(key) {
    case 'name': return (e.name || '').toLowerCase();
    case 'transactions': return e.transactions || 0;
    case 'net_sales': return e.net_sales || 0;
    case 'avg_basket': return e.avg_basket || 0;
    case 'ipt': return e.transactions > 0 ? e.items / e.transactions : 0;
    case 'share': return btTotalSales > 0 ? e.net_sales / btTotalSales : 0;
    default: return 0;
  }
}

function renderBudtenderTable() {
  const el = document.getElementById('btContent');
  if (!btRawData.length) { el.innerHTML = '<div class="loading">NO BUDTENDER DATA FOR LAST WEEK</div>'; return; }

  // Sort: apply multi-column sort (first sort key = highest priority)
  let sorted = [...btRawData];
  if (btSortCols.length > 0) {
    sorted.sort((a, b) => {
      for (const { key, dir } of btSortCols) {
        const va = btGetValue(a, key), vb = btGetValue(b, key);
        let cmp = 0;
        if (typeof va === 'string') cmp = va.localeCompare(vb);
        else cmp = va - vb;
        if (cmp !== 0) return dir === 'asc' ? cmp : -cmp;
      }
      return 0;
    });
  }

  const cols = [
    { key: 'name', label: 'BUDTENDER' },
    { key: 'transactions', label: 'TRANSACTIONS' },
    { key: 'net_sales', label: 'NET SALES' },
    { key: 'avg_basket', label: 'AVG BASKET' },
    { key: 'ipt', label: 'ITEMS/TXN' },
    { key: 'share', label: 'SHARE' },
  ];

  let html = `<table class="data-table"><thead><tr><th>#</th>`;
  cols.forEach(c => {
    const isActive = btSortCols.some(s => s.key === c.key);
    html += `<th style="cursor:pointer;user-select:none;${isActive ? 'color:var(--accent)' : ''}" onclick="btToggleSort('${c.key}')">${c.label}${btSortArrow(c.key)}</th>`;
  });
  html += `</tr></thead><tbody>`;

  sorted.forEach((e, i) => {
    const share = btTotalSales > 0 ? (e.net_sales / btTotalSales * 100).toFixed(1) : 0;
    const ipt = e.transactions > 0 ? (e.items / e.transactions).toFixed(1) : 0;
    html += `<tr>
      <td style="font-weight:700;color:var(--accent)">${i+1}</td>
      <td style="font-weight:600">${e.name}</td>
      <td>${e.transactions}</td>
      <td style="font-weight:700">${fmtK(e.net_sales)}</td>
      <td>${fmt(e.avg_basket)}</td>
      <td>${ipt}</td>
      <td>${share}%</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  el.innerHTML = html;
}

async function loadBudtenders(storeId) {
  const el = document.getElementById('btContent');
  el.innerHTML = '<div class="loading">LOADING BUDTENDER DATA</div>';
  btSortCols = []; // reset sort on store change

  try {
    const lw = dashboardData?.meta?.dateRanges?.lastWeek;
    const data = await api(`/api/employees?store=${storeId}&start=${lw.start}&end=${lw.end}`);
    btRawData = data.employees || [];
    btTotalSales = btRawData.reduce((s, e) => s + e.net_sales, 0);
    renderBudtenderTable();
  } catch (e) {
    el.innerHTML = `<div class="loading" style="color:var(--red)">ERROR: ${e.message}</div>`;
  }
}

// ═══════════════════════════════════════════════════════════════
// CUSTOM RANGE TAB — Compare & Analyze
// ═══════════════════════════════════════════════════════════════
function setQuickRange(preset) {
  const now = new Date();
  const d2s = d => d.toISOString().split('T')[0];
  const dow = now.getDay();

  let aStart, aEnd, bStart, bEnd;

  if (preset === 'week') {
    const mon = new Date(now); mon.setDate(now.getDate() - ((dow + 6) % 7));
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
    aStart = d2s(mon); aEnd = d2s(sun);
    const monP = new Date(mon); monP.setDate(mon.getDate() - 7);
    const sunP = new Date(monP); sunP.setDate(monP.getDate() + 6);
    bStart = d2s(monP); bEnd = d2s(sunP);
  } else if (preset === 'lastweek') {
    const mon = new Date(now); mon.setDate(now.getDate() - ((dow + 6) % 7) - 7);
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
    aStart = d2s(mon); aEnd = d2s(sun);
    const monP = new Date(mon); monP.setDate(mon.getDate() - 7);
    const sunP = new Date(monP); sunP.setDate(monP.getDate() + 6);
    bStart = d2s(monP); bEnd = d2s(sunP);
  } else if (preset === '30d') {
    const s = new Date(now); s.setDate(s.getDate() - 30);
    aStart = d2s(s); aEnd = d2s(now);
    const s2 = new Date(s); s2.setDate(s2.getDate() - 30);
    const e2 = new Date(s); e2.setDate(e2.getDate() - 1);
    bStart = d2s(s2); bEnd = d2s(e2);
  } else if (preset === 'ytd') {
    aStart = now.getFullYear() + '-01-01'; aEnd = d2s(now);
    bStart = (now.getFullYear() - 1) + '-01-01';
    const lastYearSameDay = new Date(now); lastYearSameDay.setFullYear(now.getFullYear() - 1);
    bEnd = d2s(lastYearSameDay);
  } else if (preset === 'lastyear') {
    const ly = now.getFullYear() - 1;
    aStart = ly + '-01-01'; aEnd = ly + '-12-31';
    const ly2 = ly - 1;
    bStart = ly2 + '-01-01'; bEnd = ly2 + '-12-31';
  } else if (preset === 'monthvmonth') {
    const y = now.getFullYear(), m = now.getMonth();
    aStart = y + '-' + String(m + 1).padStart(2, '0') + '-01'; aEnd = d2s(now);
    const pm = m === 0 ? 11 : m - 1;
    const py = m === 0 ? y - 1 : y;
    const pmDays = new Date(py, pm + 1, 0).getDate();
    bStart = py + '-' + String(pm + 1).padStart(2, '0') + '-01';
    bEnd = py + '-' + String(pm + 1).padStart(2, '0') + '-' + String(pmDays).padStart(2, '0');
  }

  document.getElementById('rangeAStart').value = aStart;
  document.getElementById('rangeAEnd').value = aEnd;
  document.getElementById('rangeBStart').value = bStart;
  document.getElementById('rangeBEnd').value = bEnd;
  document.getElementById('rangeBEnabled').checked = true;
  runCustomRange();
}

async function runCustomRange() {
  const aStart = document.getElementById('rangeAStart').value;
  const aEnd = document.getElementById('rangeAEnd').value;
  const bEnabled = document.getElementById('rangeBEnabled').checked;
  const bStart = document.getElementById('rangeBStart').value;
  const bEnd = document.getElementById('rangeBEnd').value;
  const el = document.getElementById('rangeResults');

  if (!aStart || !aEnd) { el.innerHTML = '<div class="loading">SELECT A DATE RANGE</div>'; return; }

  el.innerHTML = '<div class="loading">RUNNING REPORT...</div>';

  try {
    const dataA = await api('/api/sales?start=' + aStart + '&end=' + aEnd);
    const resultsA = Array.isArray(dataA) ? dataA : [];
    let resultsB = null;

    if (bEnabled && bStart && bEnd) {
      const dataB = await api('/api/sales?start=' + bStart + '&end=' + bEnd);
      resultsB = Array.isArray(dataB) ? dataB : [];
    }

    if (resultsA.length === 0) { el.innerHTML = '<div class="loading">NO DATA FOR RANGE A</div>'; return; }

    // Aggregate totals
    const aggA = aggregateRange(resultsA);
    const aggB = resultsB ? aggregateRange(resultsB) : null;

    let html = '';

    // ── KPI COMPARISON ──
    html += '<div class="section-title"><span>◆</span> SUMMARY</div>';
    html += '<div class="kpi-row">';
    html += buildCompareKpi('NET SALES', fmtK(aggA.netSales), aggB ? fmtK(aggB.netSales) : null, aggB ? pctChange(aggA.netSales, aggB.netSales) : null);
    html += buildCompareKpi('TRANSACTIONS', aggA.txns.toLocaleString(), aggB ? aggB.txns.toLocaleString() : null, aggB ? pctChange(aggA.txns, aggB.txns) : null);
    html += buildCompareKpi('AVG BASKET', fmt(aggA.avgBasket), aggB ? fmt(aggB.avgBasket) : null, aggB ? pctChange(aggA.avgBasket, aggB.avgBasket) : null);
    html += buildCompareKpi('ITEMS / TXN', aggA.txns > 0 ? (aggA.items / aggA.txns).toFixed(1) : '0', aggB && aggB.txns > 0 ? (aggB.items / aggB.txns).toFixed(1) : null, null);
    html += '</div>';

    // Period labels
    html += '<div style="font-family:var(--mono);font-size:9px;color:var(--muted);margin-bottom:16px;">';
    html += '<span style="color:var(--accent);">A:</span> ' + aStart + ' → ' + aEnd;
    if (aggB) html += ' &nbsp;|&nbsp; <span style="color:var(--muted);">B:</span> ' + bStart + ' → ' + bEnd;
    html += '</div>';

    // ── STORE BREAKDOWN ──
    html += '<div class="section-title"><span>◆</span> STORE BREAKDOWN</div>';
    html += '<table class="data-table"><thead><tr><th>STORE</th><th>NET SALES (A)</th>';
    if (aggB) html += '<th>NET SALES (B)</th><th>CHANGE</th>';
    html += '<th>TXNS (A)</th><th>AVG BASKET (A)</th><th>SHARE</th></tr></thead><tbody>';

    const sortedA = [...resultsA].sort((a, b) => (b.summary?.net_sales || 0) - (a.summary?.net_sales || 0));
    sortedA.forEach(r => {
      const sA = r.summary || {};
      const sB = resultsB ? (resultsB.find(rb => rb.store?.id === r.store?.id)?.summary || {}) : null;
      const share = aggA.netSales > 0 ? (sA.net_sales / aggA.netSales * 100).toFixed(1) : 0;
      const ch = sB && sB.net_sales > 0 ? pctChange(sA.net_sales, sB.net_sales) : null;
      const chColor = ch != null ? (ch >= 0 ? 'var(--green)' : 'var(--red)') : 'var(--muted)';
      const color = stores.find(s => s.id === r.store?.id)?.color || '#888';

      html += '<tr>';
      html += '<td style="font-weight:600;"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + color + ';margin-right:6px;"></span>' + (r.store?.name || '—') + '</td>';
      html += '<td style="font-weight:700;">' + fmtK(sA.net_sales) + '</td>';
      if (sB !== null) {
        html += '<td style="color:var(--muted)">' + fmtK(sB.net_sales || 0) + '</td>';
        html += '<td style="color:' + chColor + ';font-weight:700">' + (ch != null ? pctFmt(ch) : '—') + '</td>';
      }
      html += '<td>' + (sA.transaction_count || 0).toLocaleString() + '</td>';
      html += '<td>' + fmt(sA.avg_basket) + '</td>';
      html += '<td>' + share + '%</td>';
      html += '</tr>';
    });
    html += '</tbody></table>';

    // ── CATEGORY BREAKDOWN ──
    if (aggA.categories.length > 0) {
      html += '<div class="section-title"><span>◆</span> CATEGORY BREAKDOWN</div>';
      html += '<table class="data-table"><thead><tr><th>CATEGORY</th><th>NET SALES (A)</th>';
      if (aggB) html += '<th>NET SALES (B)</th><th>CHANGE</th>';
      html += '<th>UNITS (A)</th><th>SHARE</th></tr></thead><tbody>';

      const catBMap = {};
      if (aggB) aggB.categories.forEach(c => { catBMap[c.name] = c; });

      aggA.categories.forEach(cat => {
        const catB = catBMap[cat.name];
        const share = aggA.netSales > 0 ? (cat.net_sales / aggA.netSales * 100).toFixed(1) : 0;
        const ch = catB && catB.net_sales > 0 ? pctChange(cat.net_sales, catB.net_sales) : null;
        const chColor = ch != null ? (ch >= 0 ? 'var(--green)' : 'var(--red)') : 'var(--muted)';
        const rowBg = ch != null ? (ch >= 10 ? 'rgba(0,229,160,0.06)' : ch <= -10 ? 'rgba(255,77,109,0.06)' : 'transparent') : 'transparent';

        html += '<tr style="background:' + rowBg + '">';
        html += '<td style="font-weight:600">' + cat.name + '</td>';
        html += '<td style="font-weight:700">' + fmtK(cat.net_sales) + '</td>';
        if (aggB) {
          html += '<td style="color:var(--muted)">' + fmtK(catB?.net_sales || 0) + '</td>';
          html += '<td style="color:' + chColor + ';font-weight:700">' + (ch != null ? pctFmt(ch) : '—') + '</td>';
        }
        html += '<td>' + cat.units + '</td>';
        html += '<td>' + share + '%</td>';
        html += '</tr>';
      });
      html += '</tbody></table>';
    }

    // ── CUSTOMER MIX ──
    html += '<div class="section-title"><span>◆</span> CUSTOMER MIX</div>';
    html += '<div class="kpi-row">';
    html += buildCompareKpi('RECREATIONAL', aggA.rec.toLocaleString() + ' (' + (aggA.txns > 0 ? (aggA.rec / aggA.txns * 100).toFixed(0) : 0) + '%)',
      aggB ? aggB.rec.toLocaleString() + ' (' + (aggB.txns > 0 ? (aggB.rec / aggB.txns * 100).toFixed(0) : 0) + '%)' : null, null);
    html += buildCompareKpi('MEDICAL', aggA.med.toLocaleString() + ' (' + (aggA.txns > 0 ? (aggA.med / aggA.txns * 100).toFixed(0) : 0) + '%)',
      aggB ? aggB.med.toLocaleString() + ' (' + (aggB.txns > 0 ? (aggB.med / aggB.txns * 100).toFixed(0) : 0) + '%)' : null, null);
    html += '</div>';

    el.innerHTML = html;
  } catch (e) {
    el.innerHTML = '<div class="loading" style="color:var(--red)">ERROR: ' + e.message + '</div>';
  }
}

function aggregateRange(results) {
  let netSales = 0, grossSales = 0, txns = 0, items = 0, rec = 0, med = 0;
  const catMap = {};

  results.forEach(r => {
    const s = r.summary || {};
    netSales += s.net_sales || 0;
    grossSales += s.gross_sales || 0;
    txns += s.transaction_count || 0;
    items += s.total_items || 0;
    rec += s.customer_types?.rec || 0;
    med += s.customer_types?.med || 0;
    (s.categories || []).forEach(c => {
      if (!catMap[c.name]) catMap[c.name] = { name: c.name, net_sales: 0, units: 0 };
      catMap[c.name].net_sales += c.net_sales || 0;
      catMap[c.name].units += c.units || 0;
    });
  });

  return {
    netSales, grossSales, txns, items, rec, med,
    avgBasket: txns > 0 ? netSales / txns : 0,
    categories: Object.values(catMap).sort((a, b) => b.net_sales - a.net_sales),
  };
}

function buildCompareKpi(label, valA, valB, change) {
  let sub = '';
  if (valB != null) sub += '<div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:4px;">B: ' + valB + '</div>';
  if (change != null) sub += '<div class="change ' + pctClass(change) + '">' + pctFmt(change) + ' vs B</div>';
  return '<div class="kpi"><div class="label">' + label + '</div><div class="value">' + valA + '</div>' + sub + '</div>';
}

// ── Auto-refresh every 5 min ────────────────────────────────
setInterval(() => { if (dashboardData) { loadDashboard(); loadTrend(); } }, 5 * 60 * 1000);

</script>
</body>
</html>
